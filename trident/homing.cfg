#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 5400

## Used for sensorless homing
[homing_override]
axes: xyz
gcode:
  # Determine which axes to home
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  # Ensure safe bed clearance before any homing operations
  _ENSURE_SAFE_BED_CLEARANCE

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}

  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}

  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}

[gcode_macro _ENSURE_SAFE_BED_CLEARANCE]
description: Move bed down to safe position for X/Y homing, preserve Z homed state
gcode:
  {% if 'z' not in printer.toolhead.homed_axes %}
  # Temporarily set Z as homed and at axis position 0 so we can move the bed
  SET_KINEMATIC_POSITION SET_HOMED=Z Z=0
  # Move bed down to create safe clearance for X/Y homing
  _MOVE_BED_TO_SAFE_POSITION
  # Reset Z to show as not homed
  SET_KINEMATIC_POSITION SET_HOMED= CLEAR_HOMED=Z
  {% else %}
    _MOVE_BED_TO_SAFE_POSITION
  {% endif %}

[gcode_macro _MOVE_BED_TO_SAFE_POSITION]
gcode:
  {% if printer.toolhead.position.z < 10 %}
    G90
    G1 Z10
  {% endif %}

## Commented out because of sensorless homing
# [safe_z_home]
# ##  XY Location of the Z Endstop Switch
# ##  Update -10,-10 to the XY coordinates of your endstop pin
# ##  (such as 157,305) after going through Z Endstop Pin
# ##  Location Definition step.
# home_xy_position:150,150
# speed:100
# z_hop:10

[z_tilt]
##  Use Z_TILT_ADJUST to level the bed .
##  z_positions: Location of toolhead

# z_positions are the physical pivot points for the bed
z_positions:
  -50, 18
  150, 348
  350, 18
points:
  # original probe points
  #30, 5
  #150, 245
  #270, 5
  25, 3
  150, 253 # carto is 22mm behind the nozzle so this puts carto at 275 for the probe point
  275, 3
speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0075

#  Software based skew correction can help resolve dimensional inaccuracies resulting from a printer assembly that is not perfectly square.
[skew_correction]

